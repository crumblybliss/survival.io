<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Car Shop</title>
<style>
  body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
  h1, h2 { color: #333; }
  #login-section, #cart-section { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
  input, select, button { margin: 5px 0; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
  button { cursor: pointer; background: #007BFF; color: #fff; border: none; }
  button:hover { background: #0056b3; }
  ul { list-style: none; padding: 0; }
  li { padding: 10px; background: #fafafa; margin-bottom: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; }
  .item-info { display: flex; align-items: center; gap: 10px; }
  .removeBtn { background: #dc3545; margin-left: 10px; }
  .removeBtn:hover { background: #a71d2a; }
</style>
</head>
<body>

<h1>Car Shop</h1>

<div id="login-section">
  <h2>Login / Sign Up</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <br>
  <button id="loginBtn">Login</button>
  <button id="signupBtn">Sign Up</button>
</div>

<div id="cart-section" style="display:none;">
  <h2>Your Cart</h2>
  <ul id="cart-list"></ul>
  <button id="checkoutBtn">Checkout</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, doc, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Elements
const loginSection = document.getElementById("login-section");
const cartSection = document.getElementById("cart-section");
const cartList = document.getElementById("cart-list");
const loginBtn = document.getElementById("loginBtn");
const signupBtn = document.getElementById("signupBtn");
const checkoutBtn = document.getElementById("checkoutBtn");

let userUID = null;
let unsubscribeCart = null;

// Login
loginBtn.addEventListener("click", () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  signInWithEmailAndPassword(auth, email, password)
    .catch(err => alert(err.message));
});

// Sign Up
signupBtn.addEventListener("click", () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  createUserWithEmailAndPassword(auth, email, password)
    .catch(err => alert(err.message));
});

// Auth State
onAuthStateChanged(auth, user => {
  if (user) {
    userUID = user.uid;
    loginSection.style.display = "none";
    cartSection.style.display = "block";
    loadCartRealtime();
  } else {
    userUID = null;
    loginSection.style.display = "block";
    cartSection.style.display = "none";
    if (unsubscribeCart) unsubscribeCart();
  }
});

// Load Cart Real-time
function loadCartRealtime() {
  const userCartRef = collection(db, "carts");

  if (unsubscribeCart) unsubscribeCart();

  unsubscribeCart = onSnapshot(userCartRef, snapshot => {
    cartList.innerHTML = "";
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      if (data.uid !== userUID) return; // only current user

      const li = document.createElement("li");
      li.innerHTML = `
        <div class="item-info">
          <strong>${data.carName}</strong>
          Color: <input type="color" value="${data.color || '#ffffff'}" data-id="${docSnap.id}" class="color">
          Size: 
          <select data-id="${docSnap.id}" class="size">
            <option value="small" ${data.size==='small'?'selected':''}>Small</option>
            <option value="medium" ${data.size==='medium'?'selected':''}>Medium</option>
            <option value="large" ${data.size==='large'?'selected':''}>Large</option>
          </select>
        </div>
        <button data-id="${docSnap.id}" class="removeBtn">Remove</button>
      `;
      cartList.appendChild(li);
    });

    // Event Listeners
    document.querySelectorAll(".color").forEach(input => {
      input.addEventListener("input", e => {
        updateDoc(doc(db, "carts", e.target.dataset.id), { color: e.target.value });
      });
    });
    document.querySelectorAll(".size").forEach(select => {
      select.addEventListener("change", e => {
        updateDoc(doc(db, "carts", e.target.dataset.id), { size: e.target.value });
      });
    });
    document.querySelectorAll(".removeBtn").forEach(btn => {
      btn.addEventListener("click", e => {
        deleteDoc(doc(db, "carts", e.target.dataset.id));
      });
    });
  });
}

// Checkout
checkoutBtn.addEventListener("click", async () => {
  const userCartRef = collection(db, "carts");
  const snapshot = await getDocs(userCartRef);
  const orders = [];

  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    if (data.uid !== userUID) return;
    orders.push({
      carName: data.carName,
      color: data.color || '#ffffff',
      size: data.size || 'medium',
      uid: userUID,
      timestamp: new Date()
    });
  });

  for (const order of orders) {
    await addDoc(collection(db, "orders"), order);
  }

  alert("Order placed!");
});
</script>

</body>
</html>
