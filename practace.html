<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel — Bracelets & Cookies</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#0f1b2b; --panel:#111f34; --muted:#9aa8c2; --accent:#1e90ff;
  --card:#0f233f; --danger:#dc3545; --success:#28a745; --surface:#13233a;
}
*{box-sizing:border-box;}
html,body{margin:0; font-family:'Roboto', sans-serif; background:linear-gradient(180deg,var(--bg) 0%,#071022 100%); color:#e6eef8; height:100%;}
header{display:flex; justify-content:space-between; align-items:center; padding:18px 24px; background:rgba(18,34,58,0.95); border-bottom:1px solid rgba(255,255,255,0.05); backdrop-filter: blur(4px);}
header h1{margin:0;font-size:1.2rem;color:var(--accent);}
header .sub{color:var(--muted); font-size:0.85rem;}
.controls{display:flex; gap:10px; align-items:center;}
.controls button{font-size:0.85rem; padding:6px 10px; border-radius:6px; transition:all .15s; cursor:pointer;}
.controls button:hover{transform:translateY(-2px); opacity:0.9;}
main{max-width:1400px;margin:20px auto;padding:0 20px 60px;}
.section{background: rgba(17,32,52,0.6); backdrop-filter: blur(10px); border-radius:12px; padding:18px; margin-bottom:20px; box-shadow:0 12px 28px rgba(0,0,0,0.45); border:1px solid rgba(255,255,255,0.03); transition:transform .2s;}
.section:hover{transform:translateY(-2px);}
h2{color:var(--accent); margin:0 0 14px 0;}
.table-wrapper{overflow:auto; border-radius:8px; border:1px solid rgba(255,255,255,0.03);}
table{width:100%; border-collapse:collapse; display:block;}
th, td{padding:12px 14px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.05);}
tr:hover td{background:rgba(30,144,255,0.05);}
button{background:var(--accent); color:#fff; border:0; border-radius:8px; padding:10px 14px; cursor:pointer; font-weight:600; transition:all .12s;}
button:hover{transform:translateY(-2px); opacity:0.95; box-shadow:0 4px 18px rgba(30,144,255,0.3);}
button.btn-danger{background:var(--danger);}
button.btn-ghost{background:transparent; border:1px solid rgba(255,255,255,0.05); color:var(--muted);}
input, select, textarea{width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:var(--surface); color:inherit; font-size:0.95rem; outline:none; transition:all .12s;}
input:focus, select:focus, textarea:focus{box-shadow:0 0 0 4px rgba(30,144,255,0.1); transform:translateY(-1px);}
.stats-cards{display:flex; gap:14px; flex-wrap:wrap; margin-bottom:20px;}
.stats-card{flex:1; min-width:120px; background:var(--card); padding:16px; border-radius:12px; box-shadow:0 8px 16px rgba(0,0,0,0.35); text-align:center; transition:transform .15s;}
.stats-card:hover{transform:translateY(-2px);}
.stats-card h3{margin:0;font-size:1.2rem;color:var(--accent);}
.stats-card p{margin:4px 0 0; font-size:0.9rem; color:var(--muted);}
#notification{position:fixed; bottom:20px; right:20px; padding:12px 16px; border-radius:10px; color:#fff; font-weight:500; display:none; box-shadow:0 6px 22px rgba(0,0,0,0.45); opacity:0; transition:opacity .3s, transform .3s; transform:translateY(20px);}
#notification.show{display:block; opacity:1; transform:translateY(0);}
#notification.success{background:var(--success);}
#notification.error{background:var(--danger);}
.collapsible{cursor:pointer; display:flex; justify-content:space-between; align-items:center;}
.collapsible-content{max-height:0; overflow:hidden; transition:max-height .3s ease;}
.wrapper{display:flex;align-items:center;margin-bottom:5px;}
.wrapper button{margin-left:10px;}
@media(max-width:900px){header{flex-direction:column;align-items:flex-start;gap:6px;} .stats-cards{flex-direction:column;}}
</style>
</head>
<body>
<header>
  <div>
    <h1>Admin Panel</h1>
    <div class="sub">Bracelets & Cookies — Manage users, orders & products</div>
  </div>
  <div class="controls">
    <div id="adminEmailPreview" class="sub"></div>
    <button id="logoutBtn" class="btn-ghost" style="display:none;">Sign out</button>
  </div>
</header>

<main>
  <!-- LOGIN -->
  <section id="login-section" class="section">
    <h2>Admin Login</h2>
    <form id="loginForm" onsubmit="return false;" style="display:flex;gap:10px;flex-wrap:wrap;">
      <input id="adminEmail" type="email" placeholder="Email" required style="flex:1;min-width:180px;">
      <input id="adminPassword" type="password" placeholder="Password" required style="flex:1;min-width:180px;">
      <button id="loginBtn">Sign in</button>
    </form>
  </section>

  <!-- ADMIN DASHBOARD -->
  <section id="admin-section" class="section" style="display:none;">
    <h2>Dashboard</h2>
    <div class="stats-cards">
      <div class="stats-card"><h3 id="totalUsers">0</h3><p>Total Users</p></div>
      <div class="stats-card"><h3 id="activeUsers">0</h3><p>Active Today</p></div>
      <div class="stats-card"><h3 id="totalOrders">0</h3><p>Total Orders</p></div>
      <div class="stats-card"><h3 id="revenue">0</h3><p>Total Revenue</p></div>
      <div class="stats-card"><h3 id="donations">0</h3><p>Donations</p></div>
    </div>

    <!-- Users Section -->
    <div class="section collapsible">
      <h2>Users</h2><button>▼</button>
    </div>
    <div class="collapsible-content">
      <input type="text" id="searchUsers" placeholder="Search Users..." style="margin-bottom:10px;">
      <div class="table-wrapper"><table id="usersTable"><thead><tr><th>Email</th><th>UID</th><th>Role</th><th>Created</th><th>Action</th></tr></thead><tbody></tbody></table></div>
    </div>

    <!-- Orders Section -->
    <div class="section collapsible">
      <h2>Orders</h2><button>▼</button>
    </div>
    <div class="collapsible-content">
      <input type="text" id="searchOrders" placeholder="Search Orders..." style="margin-bottom:10px;">
      <div class="table-wrapper"><table id="ordersTable"><thead><tr><th>Order ID</th><th>User UID</th><th>Total</th><th>Donation</th><th>Gift</th><th>Status</th><th>Items</th><th>Action</th></tr></thead><tbody></tbody></table></div>
    </div>

    <!-- Products Section -->
    <div class="section collapsible">
      <h2>Products</h2><button>▼</button>
    </div>
    <div class="collapsible-content" id="productsSection">
      <button type="button" id="addProductBtn">+ Add Product</button>
      <div id="productEditorContainer"></div>
      <div class="table-wrapper">
        <table id="productsTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Price</th>
              <th>Colors</th>
              <th>Sizes</th>
              <th>Flavors</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </section>
</main>

<div id="notification"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-functions.js";

const firebaseConfig = {
  apiKey:"AIzaSyCrdPP5q_eZ4OqqcCW1nguD89f5VHLPVU0",
  authDomain:"survival-f35e2.firebaseapp.com",
  projectId:"survival-f35e2",
  storageBucket:"survival-f35e2.appspot.com",
  messagingSenderId:"704462603548",
  appId:"1:704462603548:android:00d1a3fb89f9106a59e6d9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const functions = getFunctions(app);

const loginSection = document.getElementById("login-section");
const adminSection = document.getElementById("admin-section");
const loginForm = document.getElementById("loginForm");
const logoutBtn = document.getElementById("logoutBtn");
const adminEmailPreview = document.getElementById("adminEmailPreview");
const notification = document.getElementById("notification");
const usersTableBody = document.querySelector("#usersTable tbody");
const productsTableBody = document.querySelector("#productsTable tbody");
const addProductBtn = document.getElementById("addProductBtn");
const productEditorContainer = document.getElementById("productEditorContainer");

function showNotification(msg,type="success"){
  notification.textContent = msg;
  notification.className = type+" show";
  setTimeout(()=>{ notification.className=""; },3000);
}

function createCell(text){ const td = document.createElement("td"); td.textContent = text||"—"; return td; }

// LOGIN
loginForm.addEventListener("submit", async ()=>{
  const email = document.getElementById("adminEmail").value;
  const pass = document.getElementById("adminPassword").value;
  try { await signInWithEmailAndPassword(auth,email,pass); }
  catch(err){ showNotification(err.message,"error"); }
});
logoutBtn.addEventListener("click",()=>signOut(auth));

// DASHBOARD
onAuthStateChanged(auth, async user=>{
  if(user){
    loginSection.style.display="none"; adminSection.style.display="block";
    logoutBtn.style.display="inline-block"; adminEmailPreview.textContent=user.email;
    loadDashboard(); loadUsers(); loadOrders(); loadProducts();
  }else{
    loginSection.style.display="block"; adminSection.style.display="none";
    logoutBtn.style.display="none"; adminEmailPreview.textContent="";
  }
});

// USERS
async function loadUsers(){
  usersTableBody.innerHTML="<tr><td colspan='5'>Loading...</td></tr>";
  try{
    const snapshot = await getDocs(collection(db,"users"));
    usersTableBody.innerHTML="";
    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      const tr = document.createElement("tr");
      tr.appendChild(createCell(data.email));
      tr.appendChild(createCell(docSnap.id));
      const roleTd = document.createElement("td");
      const roleSelect = document.createElement("select");
      ["user","admin","banned"].forEach(r=>{
        const opt = document.createElement("option"); opt.value=r; opt.text=r; if(r===data.role) opt.selected=true; roleSelect.appendChild(opt);
      });
      roleSelect.addEventListener("change",()=>updateDoc(doc(db,"users",docSnap.id),{role:roleSelect.value}));
      roleTd.appendChild(roleSelect); tr.appendChild(roleTd);
      tr.appendChild(createCell(data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString() : "—"));

      // IMPERSONATE BUTTON
      const actTd = document.createElement("td");
      const btn = document.createElement("button");
      btn.textContent = "Impersonate";
      btn.onclick = ()=>impersonateUser(docSnap.id);
      actTd.appendChild(btn);
      tr.appendChild(actTd);

      usersTableBody.appendChild(tr);
    });
  }catch(err){ usersTableBody.innerHTML="<tr><td colspan='5'>Failed to load users</td></tr>"; showNotification("Failed to load users","error"); }
}

// IMPERSONATE FUNCTION
async function impersonateUser(uid){
  try{
    const func = httpsCallable(functions,"impersonateUser");
    const result = await func({uid});
    await signInWithCustomToken(auth,result.data.token);
    showNotification("Now impersonating user: " + uid);
  }catch(err){ console.error(err); showNotification("Failed to impersonate: " + err.message,"error"); }
}

// PRODUCTS
addProductBtn.addEventListener("click",()=>addProduct());
function addProduct(){
  const wrapper = document.createElement("div");
  wrapper.className="section"; wrapper.style.margin="10px 0";
  wrapper.innerHTML=`
    <div class="wrapper"><input placeholder="Product Name" class="prod-name"><button type="button" class="btn btn-danger remove-btn">Remove</button></div>
    <div class="wrapper"><input type="number" placeholder="Price" class="prod-price"></div>
    <div class="wrapper"><input placeholder="Colors (comma separated)" class="prod-colors"></div>
    <div class="wrapper"><input placeholder="Sizes (comma separated)" class="prod-sizes"></div>
    <div class="wrapper"><input placeholder="Flavors (comma separated)" class="prod-flavors"></div>
    <button type="button" class="btn save-btn">Save Product</button>
  `;
  productEditorContainer.appendChild(wrapper);
  wrapper.querySelector(".remove-btn").onclick=()=>wrapper.remove();
  wrapper.querySelector(".save-btn").onclick=async ()=>{
    const p={
      name: wrapper.querySelector(".prod-name").value.trim(),
      price: parseFloat(wrapper.querySelector(".prod-price").value)||0,
      colors: wrapper.querySelector(".prod-colors").value.split(",").map(s=>s.trim()).filter(Boolean),
      sizes: wrapper.querySelector(".prod-sizes").value.split(",").map(s=>s.trim()).filter(Boolean),
      flavors: wrapper.querySelector(".prod-flavors").value.split(",").map(s=>s.trim()).filter(Boolean)
    };
    try{
      const productRef = doc(collection(db,"products"));
      await setDoc(productRef,p);
      showNotification("Product saved!");
      wrapper.remove();
      loadProducts();
    }catch(err){ console.error(err); showNotification("Failed to save product","error"); }
  };
}

async function loadProducts(){
  productsTableBody.innerHTML="<tr><td colspan='6'>Loading...</td></tr>";
  try{
    const snapshot = await getDocs(collection(db,"products"));
    productsTableBody.innerHTML="";
    snapshot.forEach(docSnap=>{
      const p = docSnap.data();
      const tr = document.createElement("tr");
      tr.appendChild(createCell(p.name));
      tr.appendChild(createCell(p.price?"$"+p.price:""));
      tr.appendChild(createCell((p.colors||[]).join(", ")));
      tr.appendChild(createCell((p.sizes||[]).join(", ")));
      tr.appendChild(createCell((p.flavors||[]).join(", ")));
      const actTd = document.createElement("td");
      const btn = document.createElement("button");
      btn.textContent="Edit"; btn.onclick=()=>alert("Edit via editor above");
      actTd.appendChild(btn); tr.appendChild(actTd);
      productsTableBody.appendChild(tr);
    });
  }catch(err){ productsTableBody.innerHTML="<tr><td colspan='6'>Failed to load products</td></tr>"; showNotification("Failed to load products","error"); }
}

// COLLAPSIBLES
document.querySelectorAll(".collapsible button").forEach(b=>b.addEventListener("click",()=>{
  const content = b.parentElement.nextElementSibling;
  content.style.maxHeight = content.style.maxHeight ? null : content.scrollHeight + "px";
}));

</script>
</body>
</html>
