<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCrdPP5q_eZ4OqqcCW1nguD89f5VHLPVU0",
    authDomain: "survival-f35e2.firebaseapp.com",
    projectId: "survival-f35e2",
    storageBucket: "survival-f35e2.appspot.com",
    messagingSenderId: "704462603548",
    appId: "1:704462603548:android:00d1a3fb89f9106a59e6d9"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth();

  // Admin check function
  const adminCheck = () => {
    onAuthStateChanged(auth, (user) => {
      if (user) {
        user.getIdTokenResult().then((idTokenResult) => {
          if (idTokenResult.claims.admin) {
            console.log("User is an admin.");
            document.getElementById('adminContainer').style.display = 'block'; // Show admin panel content
            document.getElementById('adminLink').style.display = 'none'; // Hide the admin link if logged in
            loadProducts(); // Load products after admin check
          } else {
            console.log("User is not an admin.");
            alert("You do not have admin privileges.");
            window.location.href = "index.html";  // Redirect if not an admin
          }
        });
      } else {
        console.log("No user signed in");
      }
    });
  };

  // Load products from Firestore
  const loadProducts = async () => {
    const productList = document.getElementById("productList");
    productList.innerHTML = "";  // Clear the product list

    const allCollections = ["cookies", "bracelets"];
    
    for (const col of allCollections) {
      const collectionRef = collection(db, col);
      try {
        const snapshot = await getDocs(collectionRef);
        if (snapshot.empty) {
          console.log(`No products found in ${col} collection.`);
        }
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          console.log("Product Data:", data);  // Debugging log to see data

          const img = data.imageUrl && data.imageUrl.trim() !== "" ? data.imageUrl : "default.jpg";

          const card = document.createElement("div");
          card.className = "product-card";
          card.innerHTML = `
            <img src="${img}" alt="${data.name}" />
            <h3>${data.name}</h3>
            <p>Category: ${data.category}</p>
            <p>${(data.sizes || []).map((s, idx) => {
              const size = s.size || "Unknown";
              const price = typeof s.price === "number" ? `$${s.price.toFixed(2)}` : "N/A";
              return `${size}: ${price} (${s.color})`;
            }).join("<br>")}</p>
            <div class="actions">
              <button onclick="editProduct('${docSnap.id}', '${data.category}')">Edit</button>
              <button onclick="deleteProduct('${docSnap.id}', '${data.category}')">Delete</button>
            </div>
          `;
          productList.appendChild(card);
        });
      } catch (error) {
        console.error("Error loading products from collection:", col, error);
      }
    }
  };

  // Call adminCheck on page load
  window.onload = adminCheck;
</script>
