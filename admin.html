<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
      import { getFirestore, collection, addDoc, getDocs, getDoc, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
      import { getAuth, setPersistence, browserLocalPersistence, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCrdPP5q_eZ4OqqcCW1nguD89f5VHLPVU0",
        authDomain: "survival-f35e2.firebaseapp.com",
        projectId: "survival-f35e2",
        storageBucket: "survival-f35e2.appspot.com",
        messagingSenderId: "704462603548",
        appId: "1:704462603548:android:00d1a3fb89f9106a59e6d9"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth();

      let sizes = [];
      let editingProduct = null;

      setPersistence(auth, browserLocalPersistence)
        .then(() => {
          console.log("Persistence set to local");
        })
        .catch((error) => {
          console.error("Error setting persistence:", error);
        });

      onAuthStateChanged(auth, (user) => {
        if (user) {
          user.getIdTokenResult().then((idTokenResult) => {
            if (idTokenResult.claims.admin) {
              console.log("User is an admin.");
              document.getElementById('adminContainer').style.display = 'block';
              document.getElementById('loginForm').style.display = 'none';
              loadProducts();
              loadPromoCodes();
            } else {
              console.log("User is not an admin.");
              alert("You do not have admin privileges.");
              window.location.href = "index.html";
            }
          });
        } else {
          console.log("No user signed in");
        }
      });

      window.login = () => {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();

        if (email && password) {
          signInWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
              console.log("User signed in:", userCredential.user);
            })
            .catch((error) => {
              console.error("Error signing in:", error);
              alert("Failed to sign in.");
            });
        } else {
          alert("Please enter both email and password.");
        }
      };

      window.addSize = () => {
        const sizeInput = document.getElementById("sizeInput").value.trim();
        const priceInput = parseFloat(document.getElementById("priceInput").value.trim());
        const colorInput = document.getElementById("colorInput").value.trim();

        if (sizeInput && !isNaN(priceInput)) {
          sizes.push({
            size: sizeInput,
            price: priceInput,
            color: colorInput
          });
          updateSizeList();
          document.getElementById("sizeInput").value = "";
          document.getElementById("priceInput").value = "";
          document.getElementById("colorInput").value = "";
        } else {
          alert("Please provide valid size and price.");
        }
      };

      const updateSizeList = () => {
        const sizesListDiv = document.getElementById("sizesList");
        sizesListDiv.innerHTML = sizes.map((size, index) => `
          <div>
            Size: ${size.size}, Price: $${size.price.toFixed(2)} ${size.color ? `, Color: ${size.color}` : ""}
            <button onclick="deleteSize(${index})">Delete</button>
          </div>
        `).join('');
      };

      window.deleteSize = (index) => {
        sizes.splice(index, 1);
        updateSizeList();
      };

      window.submitProduct = async () => {
        const name = document.getElementById("productName").value.trim();
        const category = document.getElementById("productCategory").value.trim();
        const imageUrl = document.getElementById("productImage").value.trim();

        if (name && category && imageUrl && sizes.length > 0) {
          try {
            const docRef = await addDoc(collection(db, category), {
              name,
              imageUrl,
              sizes
            });
            alert("Product added successfully.");
            sizes = [];
            updateSizeList();
          } catch (e) {
            alert("Error adding product:", e);
          }
        } else {
          alert("Please fill in all fields and add at least one size.");
        }
      };

      const loadProducts = async () => {
        const categories = ["cookies", "bracelets", "coolers"];
        const productList = document.getElementById("productList");

        for (const category of categories) {
          const querySnapshot = await getDocs(collection(db, category));
          if (!querySnapshot.empty) {
            querySnapshot.forEach((doc) => {
              const product = doc.data();
              const productCard = `
                <div class="product-card">
                  <img src="${product.imageUrl}" alt="${product.name}" />
                  <h3>${product.name}</h3>
                  <div>
                    ${product.sizes.map(size => `<p>${size.size} - $${size.price}</p>`).join('')}
                  </div>
                  <div class="actions">
                    <button onclick="editProduct('${doc.id}')">Edit</button>
                    <button onclick="deleteProduct('${doc.id}')">Delete</button>
                  </div>
                </div>
              `;
              productList.innerHTML += productCard;
            });
          }
        }
      };

      window.editProduct = (productId) => {
        // Implement product edit logic here
      };

      window.deleteProduct = async (productId) => {
        try {
          const category = "cookies"; // Adjust if you implement dynamic categories
          await deleteDoc(doc(db, category, productId));
          alert("Product deleted successfully.");
          loadProducts();
        } catch (e) {
          console.error("Error deleting product:", e);
        }
      };

      window.submitPromoCode = async () => {
        const promoCode = document.getElementById("promoCodeInput").value.trim();
        const discount = parseInt(document.getElementById("discountInput").value.trim());
        const expirationDate = document.getElementById("expirationInput").value;

        if (promoCode && !isNaN(discount) && expirationDate) {
          try {
            const docRef = await addDoc(collection(db, "promoCodes"), {
              promoCode,
              discount,
              expirationDate
            });
            alert("Promo code added successfully.");
            loadPromoCodes();
          } catch (e) {
            console.error("Error adding promo code:", e);
          }
        } else {
          alert("Please fill in all fields.");
        }
      };

      const loadPromoCodes = async () => {
        const querySnapshot = await getDocs(collection(db, "promoCodes"));
        const promoCodeList = document.getElementById("promoCodeList");
        promoCodeList.innerHTML = "";
        querySnapshot.forEach((doc) => {
          const promoCode = doc.data();
          const promoCard = `
            <div class="promo-card">
              <p>Code: ${promoCode.promoCode}</p>
              <p>Discount: ${promoCode.discount}%</p>
              <p>Expires: ${promoCode.expirationDate}</p>
              <button onclick="deletePromoCode('${doc.id}')">Delete</button>
            </div>
          `;
          promoCodeList.innerHTML += promoCard;
        });
      };

      window.deletePromoCode = async (promoCodeId) => {
        try {
          await deleteDoc(doc(db, "promoCodes", promoCodeId));
          alert("Promo code deleted successfully.");
          loadPromoCodes();
        } catch (e) {
          console.error("Error deleting promo code:", e);
        }
      };
    </script>
</head>
<body>
    <div id="loginForm">
        <h2>Login</h2>
        <input type="email" id="email" placeholder="Email" />
        <input type="password" id="password" placeholder="Password" />
        <button onclick="login()">Login</button>
    </div>

    <div id="adminContainer" style="display: none;">
        <h2>Admin Panel</h2>
        <h3>Add Size</h3>
        <input type="text" id="sizeInput" placeholder="Size" />
        <input type="text" id="priceInput" placeholder="Price" />
        <input type="text" id="colorInput" placeholder="Color" />
        <button onclick="addSize()">Add Size</button>
        <div id="sizesList"></div>

        <h3>Product Info</h3>
        <input type="text" id="productName" placeholder="Product Name" />
        <input type="text" id="productCategory" placeholder="Product Category" />
        <input type="text" id="productImage" placeholder="Product Image URL" />
        <button onclick="submitProduct()">Submit Product</button>

        <div id="productList"></div>

        <h3>Add Promo Code</h3>
        <input type="text" id="promoCodeInput" placeholder="Promo Code" />
        <input type="number" id="discountInput" placeholder="Discount %" />
        <input type="date" id="expirationInput" />
        <button onclick="submitPromoCode()">Submit Promo Code</button>

        <div id="promoCodeList"></div>
    </div>
</body>
</html>
