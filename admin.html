<script type="module">
    // Firebase Config
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCrdPP5q_eZ4OqqcCW1nguD89f5VHLPVU0",
        authDomain: "survival-f35e2.firebaseapp.com",
        projectId: "survival-f35e2",
        storageBucket: "survival-f35e2.appspot.com",
        messagingSenderId: "704462603548",
        appId: "1:704462603548:android:00d1a3fb89f9106a59e6d9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let isAdmin = false;

    // Check if user is admin
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const token = await user.getIdTokenResult();
            isAdmin = token.claims.admin; // Make sure you are checking for 'admin' claim
            if (!isAdmin) {
                alert("Access Denied: You are not an admin.");
                window.location.href = "index.html";
            }
        } else {
            alert("Please log in as an admin.");
            window.location.href = "login.html";
        }
    });

    // Add product functionality
    async function addProduct(event) {
        event.preventDefault();

        const name = document.getElementById("productName").value.trim();
        const price = parseFloat(document.getElementById("productPrice").value);
        const category = document.getElementById("productCategory").value.trim();
        const imageUrl = document.getElementById("productImageUrl").value.trim();

        if (!name || isNaN(price) || !category || !imageUrl) {
            alert("Please enter valid product details.");
            return;
        }

        if (!isAdmin) {
            alert("You are not authorized to add products.");
            return;
        }

        try {
            await addDoc(collection(db, "products"), {
                name,
                price,
                category,
                imageUrl,
                createdAt: new Date()
            });

            document.getElementById("productName").value = "";
            document.getElementById("productPrice").value = "";
            document.getElementById("productCategory").value = "";
            document.getElementById("productImageUrl").value = "";

            alert("Product added successfully!");
            loadProducts();
        } catch (error) {
            console.error("Error adding product:", error);
            alert("Error adding product. Check console for details.");
        }
    }

    // Edit and delete product functionality
    async function editProduct(id, name, price, category, imageUrl) {
        if (!isAdmin) {
            alert("You are not authorized to edit products.");
            return;
        }

        const newName = prompt("Edit product name:", name);
        const newPrice = prompt("Edit product price:", price);
        const newCategory = prompt("Edit product category:", category);
        const newImageUrl = prompt("Edit product image URL:", imageUrl);

        if (newName && newPrice && newCategory && newImageUrl) {
            const productRef = doc(db, "products", id);
            await updateDoc(productRef, {
                name: newName,
                price: parseFloat(newPrice),
                category: newCategory,
                imageUrl: newImageUrl
            });
            loadProducts();
        }
    }

    async function deleteProduct(id) {
        if (!isAdmin) {
            alert("You are not authorized to delete products.");
            return;
        }

        const productRef = doc(db, "products", id);
        await deleteDoc(productRef);
        loadProducts();
    }

    window.onload = loadProducts;
</script>
